{% partialdef counter_inventory %}
<div
  class="badge badge-primary badge-lg"
  id="counter-inventory"
  hx-swap-oob="true"
>
  {{ count }} item{{ count|pluralize }}
</div>
{% endpartialdef %}

{% partialdef fields_counter %}
<div class="flex items-center gap-3 mt-1">
  <span class="text-xs text-base-content/60 flex items-center gap-1">
    <i data-lucide="clipboard-check" style="width: 12px; height: 12px"></i>
    {{ count }} field{{ count|pluralize }}
  </span>
</div>
{% endpartialdef %}

{% partialdef inventory_row %}
<div
  class="card bg-base-200 shadow-md hover:shadow-lg transition-shadow cursor-move"
  id="inventory-{{ inventory.id }}"
  draggable="true"
  data-inventory-id="{{ inventory.id }}"
>
  <div class="card-body p-4">
    <div class="flex items-center gap-4">
      {# Drag Handle #}
      <div
        class="cursor-grab active:cursor-grabbing text-base-content/40 hover:text-base-content"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-6 w-6"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 8h16M4 16h16"
          />
        </svg>
      </div>

      {# Inventory Icon & Info #}
      <span class="text-3xl w-10 text-center">{{ inventory.icon }}</span>
      <div class="flex-1 min-w-0">
        <h3 class="font-semibold text-base">{{ inventory.name }}</h3>
        {% with count=inventory.fields.count %}
          {% partial fields_counter %}
        {%  endwith %}
      </div>

      {# Actions #}
      <div class="flex gap-2">
        <button
          class="btn btn-sm btn-ghost btn-square text-error hover:bg-error hover:text-error-content"
          hx-delete="{% url 'projects:inventory:inventory_delete' project_id=project.pk inventory_id=inventory.id %}"
          hx-target="#inventory-{{ inventory.id }}"
          hx-swap="outerHTML"
          hx-confirm="Remove this inventory from the project?"
          title="Remove inventory"
        >
          <i data-lucide="trash-2" style="width: 16px; height: 16px"></i>
        </button>
      </div>
    </div>
  </div>
</div>
{% endpartialdef %}

{% partialdef inventory_empty %}
<div
  class="flex flex-col items-center justify-center py-16 text-center"
  id="emptyState"
>
  <svg
    xmlns="http://www.w3.org/2000/svg"
    class="h-16 w-16 text-base-content/20 mb-4"
    fill="none"
    viewBox="0 0 24 24"
    stroke="currentColor"
  >
    <path
      stroke-linecap="round"
      stroke-linejoin="round"
      stroke-width="2"
      d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
    />
  </svg>
  <p class="text-base-content/60 text-lg font-medium">No Inventory added yet</p>
  <p class="text-base-content/40 text-sm mt-2">
    Select templates from the left panel to build your project
  </p>
</div>
{% endpartialdef %}

<div class="card bg-base-100 shadow-xl mt-6">
  <div class="card-body">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      {# LEFT COLUMN: Available Templates (1/3 width) #}
      <div class="lg:col-span-1">
        <h2 class="card-title text-lg mb-4">
          <i data-lucide="list"></i>
          Inventory Templates
        </h2>

        <div class="space-y-2 max-h-[calc(100vh-200px)] overflow-y-auto pr-2">
          {% for template in inventory_templates %}
          <div
            class="card bg-base-200 shadow-md hover:shadow-lg transition-shadow"
          >
            <div class="card-body p-4">
              <form
                hx-post="{% url 'projects:inventory:inventory_add' project_id=project.pk %}"
                hx-target="#projectInventoryList"
                hx-swap="beforeend"
                class="flex items-center gap-4"
              >
                {% csrf_token %}
                <input
                  type="hidden"
                  name="inventory_template_id"
                  value="{{ template.id }}"
                />

                {# Inventory Icon #}
                <span class="text-3xl w-10 text-center"
                  >{{ template.icon }}</span
                >

                {# Inventory Name Input & Info #}
                <div class="flex-1 min-w-0">
                  <input
                    type="text"
                    name="override_name"
                    class="input input-sm input-bordered w-full font-semibold"
                    placeholder="Step name..."
                    value="{{ template.name }}"
                  />
                  {% with count=template.fields.count %} {% partial
                  fields_counter %} {% endwith %}
                </div>

                {# Add Button #}
                <div class="flex gap-2">
                  <button
                    type="submit"
                    class="btn btn-sm btn-primary btn-square"
                    title="Add step"
                  >
                    <i data-lucide="plus"></i>
                  </button>
                </div>
              </form>
            </div>
          </div>
          {% empty %} {% partial inventory_empty %} {% endfor %}
        </div>
      </div>

      {# RIGHT COLUMN: Current Project Inventory (2/3 width) #}
      <div class="lg:col-span-1">
        <div class="flex items-center justify-between mb-4">
          <h2 class="card-title text-lg">
            <i data-lucide="clipboard-list"></i>
            Project Inventory
          </h2>
          {% with count=project_inventory|length %} {% partial counter_inventory
          %} {% endwith %}
        </div>

        <div class="space-y-3" id="projectInventoryList">
          {% for inventory in project_inventory %} {% partial inventory_row %}
          {% empty %}
          <div
            class="flex flex-col items-center justify-center py-16 text-center"
            id="emptyState"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-16 w-16 text-base-content/20 mb-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
              />
            </svg>
            <p class="text-base-content/60 text-lg font-medium">
              No inventory added yet
            </p>
            <p class="text-base-content/40 text-sm mt-2">
              Select templates from the left panel to build your project
            </p>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Drag and Drop functionality - HTMX compatible
  (function () {
    let draggedElement = null;
    let placeholder = null;

    // Initialize drag and drop (called on page load and after htmx swaps)
    function initDragAndDrop() {
      const inventoriesList = document.getElementById("projectInventoryList");
      if (!inventoriesList) return;

      // Create placeholder element
      function createPlaceholder() {
        const div = document.createElement("div");
        div.className =
          "card bg-base-300 shadow-md border-2 border-dashed border-primary opacity-50";
        div.style.height = "80px";
        return div;
      }

      // Get element after which to insert
      function getDragAfterElement(container, y) {
        const draggableElements = [
          ...container.querySelectorAll('[draggable="true"]:not(.opacity-50)'),
        ];

        return draggableElements.reduce(
          (closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;

            if (offset < 0 && offset > closest.offset) {
              return { offset: offset, element: child };
            } else {
              return closest;
            }
          },
          { offset: Number.NEGATIVE_INFINITY }
        ).element;
      }

      // Update step order (placeholder for htmx call)
      function updateInventoryOrder() {
        const inventories = inventoryList.querySelectorAll(
          "[data-inventory-id]"
        );
        const inventoryIds = Array.from(inventories).map(
          (inventory) => inventory.dataset.inventoryId
        );

        console.log("New inventory order:", inventoryIds);

        // Example using htmx.ajax:
        htmx.ajax(
          "POST",
          "{% url 'projects:inventory:inventory_reorder' project_id=project.pk %}",
          {
            values: { inventory_order: stepinventoryIdsIds },
            swap: "none",
          }
        );
      }

      // Handle drag start (using event delegation)
      inventoriesList.addEventListener("dragstart", (e) => {
        const target = e.target.closest('[draggable="true"]');
        if (!target) return;

        draggedElement = target;
        draggedElement.classList.add("opacity-50");
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/html", draggedElement.innerHTML);
      });

      // Handle drag over
      inventoriesList.addEventListener("dragover", (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";

        const afterElement = getDragAfterElement(inventoriesList, e.clientY);

        if (!placeholder) {
          placeholder = createPlaceholder();
        }

        if (afterElement == null) {
          inventoriesList.appendChild(placeholder);
        } else {
          inventoriesList.insertBefore(placeholder, afterElement);
        }
      });

      // Handle drag end
      inventoriesList.addEventListener("dragend", (e) => {
        if (draggedElement) {
          draggedElement.classList.remove("opacity-50");

          // Insert dragged element at placeholder position
          if (placeholder && placeholder.parentNode) {
            placeholder.parentNode.insertBefore(draggedElement, placeholder);
            placeholder.remove();
          }

          // Send new order to server
          updateStepOrder();

          draggedElement = null;
          placeholder = null;
        }
      });

      // Handle drag leave
      inventoriesList.addEventListener("dragleave", (e) => {
        if (e.target === inventoriesList && placeholder) {
          placeholder.remove();
          placeholder = null;
        }
      });
    }

    // Initialize on page load
    initDragAndDrop();

    // Re-initialize after htmx swaps content into #projectStepsList
    document.body.addEventListener("htmx:afterSwap", (event) => {
      // Only reinitialize if the swap affected our steps list
      if (
        event.detail.target.id === "projectInventoryList" ||
        event.detail.target.closest("#projectInventoryList")
      ) {
        console.log(
          "HTMX swapped content, drag-and-drop still active via event delegation"
        );
        // Event listeners are still active due to delegation, no need to reinit
      }
    });
  })();
</script>
