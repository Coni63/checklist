{% load custom_filters %}

{% partialdef new_task_toggle %}
    {% if show_form %}
        <form 
            hx-post="{% url 'projects:checklist:task_create' project_id=project_id step_id=step_id %}" 
            hx-target="#task-list"
            hx-swap="beforeend"
            class="space-y-2 p-4 border rounded-lg bg-base-200"
        >
            {% csrf_token %}
            <div>
                <label class="label">Title</label>
                <input 
                    type="text" 
                    name="title" 
                    class="input input-bordered w-full" 
                    required
                    autofocus
                />
            </div>
            <div class="flex gap-2">
                <button class="btn btn-primary" type="submit">Create</button>
                <button 
                    class="btn" 
                    type="button"
                    hx-get="{% url 'projects:checklist:toggle_task_form' step_id=step_id project_id=project_id %}"
                    hx-target="#new-task-form-container"
                    hx-swap="innerHTML"
                >
                    Cancel
                </button>
            </div>
        </form>
    {% else %}
        <button 
            class="btn btn-primary"
            hx-get="{% url 'projects:checklist:toggle_task_form' step_id=step_id project_id=project_id %}?show_form=1"
            hx-target="#new-task-form-container"
            hx-swap="innerHTML"
        >
            + Add Task
        </button>
    {% endif %}
{% endpartialdef %}

{% partialdef progress_bar %}
    <div class="mb-6" id="tasks-area-progress" {% if oob %}hx-swap-oob="true"{% endif %} hx-swap="outerHTML">
        <div class="flex justify-between items-center mb-2">
            <span class="text-sm font-medium text-base-content">Progress</span>
            <span class="text-sm font-semibold text-base-content">{{ text }}</span>
        </div>
        <progress class="progress progress-primary w-full" value="{{ completion|cut:'%' }}" max="100"></progress>
        <div class="text-xs text-base-content/70 mt-1">{{ completion }} complete</div>
    </div>
{% endpartialdef %}

{% include 'common/partials/editable_header.html' with object=active_step can_edit=can_edit edit_endpoint_base=edit_endpoint_base %}

{% with completion=active_step.get_completion_percentage text=active_step.get_progress_text oob=false %}
    {% partial progress_bar %}
{% endwith %}

<div class="space-y-2 mt-6" id="task-list">
    {% for task in active_step.tasks.all %}
        {% include 'checklist/partials/task_row.html' with step_id=step_id project_id=project_id task=task index=forloop.counter %}
    {% endfor %}
</div>

<!-- BUTTON TO SHOW FORM -->
{% if 'edit' in roles %}
    <div class="mt-4"  id="new-task-form-container">
        {% with project_id=active_step.project.id step_id=active_step.id %}
            {% partial new_task_toggle %}
        {% endwith %}
    </div>
{% endif %}