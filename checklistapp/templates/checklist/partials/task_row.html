{% load custom_filters %}

<div id="task-{{task.id}}" class="card bg-base-100 shadow-md border-l-4
    {% if task.status == 'done' %}border-success
    {% elif task.status == 'na' %}border-warning
    {% else %}border-error{% endif %}
    hover:shadow-lg transition-all duration-200">
    <div class="card-body p-4">
        <div class="flex items-center gap-4">
            {# Task Number Badge #}
            <div class="badge badge-lg
                {% if task.status == 'done' %}badge-success
                {% elif task.status == 'na' %}badge-warning
                {% else %}badge-error{% endif %}
                font-bold">
                {{ task.order }}
                {% if task.manually_created %}*{% endif %}
            </div>

            {# Task Title #}
            <div class="flex-1">
                <h3 class="font-medium text-base-content
                    {% if task.status == 'done' %}italic text-base-content/60
                    {% elif task.status == 'na' %}line-through text-base-content/50{% endif %}">
                    {{task.title}}
                </h3>
                
                {% if task.status == 'done' or task.status == 'na' %}
                    <div class="flex items-center gap-2">
                         <span class="font-semibold text-base-content">{{ task.completed_by.username }}</span>
                         <span class="text-xs text-base-content/60">{{ task.completed_at|smart_timesince }}</span>
                    </div>
                {% endif %}
            </div>

            {# Action Buttons #}
            <div class="flex gap-2 items-center flex-wrap">
                {% if task.help_url %}
                    <a href="{{ task.help_url }}" target="_blank" class="btn btn-sm btn-outline-info w-20" title="Link to documentation">
                        <i data-lucide="badge-help" style="width:16px;height:16px;"></i>Help
                    </a>
                {% endif %}
                {% if task.work_url %}
                    <a href="{{ task.work_url }}" target="_blank" class="btn btn-sm btn-outline-info w-20" title="Link to action">
                        <i data-lucide="link" style="width:16px;height:16px;"></i>Link
                    </a>
                {% endif %}
                {% if task.info_text %}
                    <a href="#" class="btn btn-sm btn-outline-info w-20" 
                        data-toggle="tooltip" 
                        data-placement="top" 
                        title="{{ task.info_text }}">
                        <i data-lucide="badge-info" style="width:16px;height:16px;"></i>Info
                    </a>
                {% endif %}

                {% if 'edit' in roles %}
                    <button
                        hx-post="{% url 'projects:checklist:task_status_update' project_id=task.project_step.project.id step_id=task.project_step.id task_id=task.id %}"
                        hx-vals='{"status": "done"}'
                        hx-target="closest .card"
                        hx-swap="outerHTML"
                        class="btn btn-sm  w-20
                            {% if task.status == 'done' %}
                                btn-success
                            {% else %}
                                btn-outline
                            {% endif %}
                        ">
                        <i data-lucide="check" style="width:16px;height:16px;"></i>Done
                    </button>
                    <button
                        hx-post="{% url 'projects:checklist:task_status_update' project_id=task.project_step.project.id step_id=task.project_step.id task_id=task.id %}"
                        hx-vals='{"status": "na"}'
                        hx-target="closest .card"
                        hx-swap="outerHTML"
                        class="btn btn-sm  w-20
                            {% if task.status == 'na' %}
                                btn-warning
                            {% else %}
                                btn-outline
                            {% endif %}
                        ">
                        <i data-lucide="x" style="width:16px;height:16px;"></i>N/A
                    </button>
                {% else %}
                    <div class="tooltip tooltip-bottom" data-tip="You are not allowed to edit the project">
                        <span class="pointer-events-none opacity-50">
                            {% if task.status == 'done' %}
                                <button class="btn btn-sm w-20 btn-success">
                                    <i data-lucide="check" style="width:16px;height:16px;"></i>Done
                                </button>
                            {% elif task.status == 'na' %}
                                <button class="btn btn-sm w-20 btn-warning">
                                    <i data-lucide="x" style="width:16px;height:16px;"></i>N/A
                                </button>
                            {% else %}
                                <button class="btn btn-sm w-20 btn-outline">
                                    <i data-lucide="check" style="width:16px;height:16px;"></i>Done
                                </button>
                                <button class="btn btn-sm w-20 btn-outline">
                                    <i data-lucide="x" style="width:16px;height:16px;"></i>N/A
                                </button>
                            {% endif %}
                        </span>
                    </div>
                {% endif %}
            </div>
        </div>

        {# Comments Section #}
        <div class="mt-2 border-t border-base-300">
            <div class="flex justify-between">
                <button class="btn btn-ghost btn-sm gap-2"
                    hx-get="{% url 'projects:checklist:comment_list' project_id=task.project_step.project.id step_id=task.project_step.id task_id=task.id %}"
                    hx-target="#comment-area-{{ task.id }}"
                    hx-swap="innerHTML"
                    hx-trigger="click once"
                    onclick="toggleComment('{{ task.id }}')">
                    <i data-lucide="message-square-more" style="width:16px;height:16px;"></i>Comments
                </button>
                {% if task.manually_created and 'edit' in roles %}
                    <button
                        class="btn btn-ghost btn-xs"
                        hx-delete="{% url 'projects:checklist:task_delete' project_id=project_id step_id=step_id task_id=task.id %}"
                        hx-target="#task-{{ task.id }}"
                        hx-swap="outerHTML"
                        hx-confirm="Are you sure you want to delete this task?">
                        <i data-lucide="trash-2" style="width:16px;height:16px;"></i>
                    </button>
                {% endif %}
            </div>

            <div id="comment-area-{{ task.id }}" class="hidden mt-2">
                {# Comments will be loaded here #}
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    function toggleComment(taskId) {
        const el = document.getElementById("comment-area-" + taskId);
        el.classList.toggle("hidden");
    }
</script>
{% endblock %}
