
{# This page render the card of a single task on the project detail page #}

<div id="task-{{task.id}}" class="card bg-base-100 shadow-md border-l-4
    {% if task.status == 'done' %}border-success
    {% elif task.status == 'na' %}border-warning
    {% else %}border-error{% endif %}
    hover:shadow-lg transition-all duration-200">
    <div class="card-body p-4">
        <div class="flex items-start gap-4">
            {# Task Number Badge #}
            <div class="badge badge-lg
                {% if task.status == 'done' %}badge-success
                {% elif task.status == 'na' %}badge-warning
                {% else %}badge-primary{% endif %}
                font-bold">
                {{ task.order }}
            </div>

            {# Task Title #}
            <div class="flex-1">
                <h3 class="font-medium text-base-content
                    {% if task.status == 'done' %}line-through text-base-content/50
                    {% elif task.status == 'na' %}italic text-base-content/60{% endif %}">
                    {{task.title}}
                </h3>
                
                {% if task.status == 'done' or task.status == 'na' %}
                    <div class="flex items-center gap-2">
                         <span class="font-semibold text-base-content">{{ task.completed_by.username }}</span>
                         <span class="text-xs text-base-content/60">{{ task.completed_at|timesince }} ago</span>
                    </div>
                {% endif %}
            </div>

            {# Action Buttons #}
            <div class="flex gap-2 items-center flex-wrap">
                {% if task.help_url %}
                    <a href="{{ task.help_url }}" target="_blank" class="btn btn-sm btn-info btn-outline" title="Link to documentation">
                        â“ Help
                    </a>
                {% endif %}
                {% if task.work_url %}
                    <a href="{{ task.work_url }}" target="_blank" class="btn btn-sm btn-info btn-outline" title="Link to action">
                        ğŸ‘‰ Link
                    </a>
                {% endif %}
                {% if task.info_text %}
                    <a href="#" class="btn btn-sm btn-outline-info" 
                        data-toggle="tooltip" 
                        data-placement="top" 
                        title="{{ task.info_text }}">
                        ğŸ’¬ Info
                    </a>
                {% endif %}

                {% if 'edit' in roles %}
                    {% if task.status == 'done' %}
                        <button
                            hx-post="{% url 'projects:task_status_update' project_id=task.project_step.project.id step_id=task.project_step.id task_id=task.id %}"
                            hx-vals='{"status": "undone"}'
                            hx-target="closest .card"
                            hx-swap="outerHTML"
                            class="btn btn-sm btn-success">
                            âœ“ Done
                        </button>
                    {% else %}
                        <button
                            hx-post="{% url 'projects:task_status_update' project_id=task.project_step.project.id step_id=task.project_step.id task_id=task.id %}"
                            hx-vals='{"status": "done"}'
                            hx-target="closest .card"
                            hx-swap="outerHTML"
                            class="btn btn-sm btn-primary">
                            Done
                        </button>
                    {% endif %}

                    {% if task.status == 'na' %}
                        <button
                            hx-post="{% url 'projects:task_status_update' project_id=task.project_step.project.id step_id=task.project_step.id task_id=task.id %}"
                            hx-vals='{"status": "unna"}'
                            hx-target="closest .card"
                            hx-swap="outerHTML"
                            class="btn btn-sm btn-warning">
                            â—‹ N/A
                        </button>
                    {% else %}
                        <button
                            hx-post="{% url 'projects:task_status_update' project_id=task.project_step.project.id step_id=task.project_step.id task_id=task.id %}"
                            hx-vals='{"status": "na"}'
                            hx-target="closest .card"
                            hx-swap="outerHTML"
                            class="btn btn-sm btn-outline">
                            N/A
                        </button>
                    {% endif %}
                {% else %}
                    <div class="tooltip tooltip-bottom" data-tip="You are not allowed to edit the project">
                        <span class="pointer-events-none opacity-50">
                            {% if task.status == 'done' %}
                                <button class="btn btn-sm btn-success">
                                    âœ“ Done
                                </button>
                            {% elif task.status == 'na' %}
                                <button class="btn btn-sm btn-warning">
                                    â—‹ N/A
                                </button>
                            {% else %}
                                <button class="btn btn-sm btn-primary">
                                    Done
                                </button>
                                <button class="btn btn-sm btn-outline">
                                    N/A
                                </button>
                            {% endif %}
                        </span>
                    </div>
                {% endif %}
            </div>
        </div>

        {# Comments Section #}
        <div class="mt-3 border-t border-base-300 pt-3">
            <div class="flex justify-between">
                <button class="btn btn-ghost btn-sm gap-2"
                    hx-get="{% url 'projects:comment_list' project_id=task.project_step.project.id step_id=task.project_step.id task_id=task.id %}"
                    hx-target="#comment-area-{{ task.id }}"
                    hx-swap="innerHTML"
                    hx-trigger="click once"
                    onclick="toggleComment('{{ task.id }}')">
                    ğŸ’¬ Comments
                </button>
                {% if task.manually_created and 'edit' in roles %}
                    <button
                        class="btn btn-ghost btn-xs text-error"
                        hx-delete="{% url 'projects:task_delete' project_id=project_id step_id=step_id task_id=task.id %}"
                        hx-target="#task-{{ task.id }}"
                        hx-swap="outerHTML"
                        hx-confirm="Are you sure you want to delete this task?">
                        ğŸ—‘ï¸
                    </button>
                {% endif %}
            </div>

            <div id="comment-area-{{ task.id }}" class="hidden mt-3">
                {# Comments will be loaded here #}
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    function toggleComment(taskId) {
        const el = document.getElementById("comment-area-" + taskId);
        el.classList.toggle("hidden");
    }
</script>
{% endblock %}
