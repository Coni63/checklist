{% load partials %}

{% partialdef counter_step %}
    <div class="badge badge-primary badge-lg" id="counter-step" hx-swap-oob="true">{{ count }} step{{ count|pluralize }}</div>
{% endpartialdef %}

{% partialdef step_row %}
<div class="card bg-base-200 shadow-md hover:shadow-lg transition-shadow cursor-move" 
    id="step-{{ step.id }}"
    draggable="true"
    data-step-id="{{ step.id }}">
    <div class="card-body p-4">
        <div class="flex items-center gap-4">
            {# Drag Handle #}
            <div class="cursor-grab active:cursor-grabbing text-base-content/40 hover:text-base-content">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16" />
                </svg>
            </div>

            {# Step Icon & Info #}
            <span class="text-3xl">{{ step.icon }}</span>
            <div class="flex-1 min-w-0">
                <h3 class="font-semibold text-base">{{ step.title }}</h3>
                <div class="flex items-center gap-3 mt-1">
                    <span class="text-xs text-base-content/60 flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                        </svg>
                        {{ step.tasks.count }} task{{ step.tasks.count|pluralize }}
                    </span>
                </div>
            </div>

            {# Actions #}
            <div class="flex gap-2">
                <button
                    class="btn btn-sm btn-ghost btn-square text-error hover:bg-error hover:text-error-content"
                    hx-delete="{% url 'projects:remove_step' project_id=project.pk step_id=step.id %}"
                    hx-target="#step-{{ step.id }}"
                    hx-swap="outerHTML"
                    hx-confirm="Remove this step from the project?"
                    title="Remove step">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
</div>
{% endpartialdef %}

{% partialdef step_empty %}
<div class="flex flex-col items-center justify-center py-16 text-center" id="emptyState">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-base-content/20 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
    </svg>
    <p class="text-base-content/60 text-lg font-medium">No steps added yet</p>
    <p class="text-base-content/40 text-sm mt-2">Select templates from the left panel to build your project</p>
</div>
{% endpartialdef %}


<div class="card bg-base-100 shadow-xl mt-6">
    <div class="card-body">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            {# LEFT COLUMN: Available Templates (1/3 width) #}
            <div class="lg:col-span-1">
                <h2 class="card-title text-lg mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                    </svg>
                    Step Templates
                </h2>
                
                <div class="space-y-2 max-h-[calc(100vh-200px)] overflow-y-auto pr-2">
                    {% for template in available_templates %}
                        <div class="card bg-base-200 shadow-md hover:shadow-lg transition-shadow">
                            <div class="card-body p-4">
                                <form
                                    hx-post="{% url 'projects:add_step' project_id=project.pk %}"
                                    hx-target="#projectStepsList"
                                    hx-swap="beforeend"
                                    class="flex items-center gap-4">
                                    {% csrf_token %}
                                    <input type="hidden" name="step_template_id" value="{{ template.id }}">
                                    
                                    {# Step Icon #}
                                    <span class="text-3xl">{{ template.icon }}</span>
                                    
                                    {# Step Name Input & Info #}
                                    <div class="flex-1 min-w-0">
                                        <input
                                            type="text"
                                            name="override_name"
                                            class="input input-sm input-bordered w-full font-semibold"
                                            placeholder="Step name..."
                                            value="{{ template.name }}">
                                        <div class="flex items-center gap-3 mt-1">
                                            <span class="text-xs text-base-content/60 flex items-center gap-1">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                                                </svg>
                                                {{ template.tasks.count }} task{{ template.tasks.count|pluralize }}
                                            </span>
                                        </div>
                                    </div>

                                    {# Add Button #}
                                    <div class="flex gap-2">
                                        <button type="submit" class="btn btn-sm btn-primary btn-square" title="Add step">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                            </svg>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    {% empty %}
                        {% partial step_empty %}
                    {% endfor %}
                </div>
            </div>

            {# RIGHT COLUMN: Current Project Steps (2/3 width) #}
            <div class="lg:col-span-1">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="card-title text-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                        Project Steps
                    </h2>
                    {% with count=project_steps|length %}
                        {% partial counter_step %}
                    {% endwith %}
                </div>

                <div class="space-y-3" id="projectStepsList">
                    {% for step in project_steps %}
                        {% partial step_row %}
                    {% empty %}
                        <div class="flex flex-col items-center justify-center py-16 text-center" id="emptyState">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-base-content/20 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                            </svg>
                            <p class="text-base-content/60 text-lg font-medium">No steps added yet</p>
                            <p class="text-base-content/40 text-sm mt-2">Select templates from the left panel to build your project</p>
                        </div>
                    {% endfor %}
                </div>

                <!-- {# Action Buttons #}
                <div class="card-actions justify-end mt-6 pt-6 border-t border-base-300">
                    <a href="{% url 'projects:project_list' %}" class="btn btn-ghost gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                        Cancel
                    </a>
                    <a href="{% url 'projects:project_list' %}" class="btn btn-primary gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        Save & Close
                    </a>
                </div> -->
            </div>
        </div>
    </div>
</div>

<script>
// Drag and Drop functionality - HTMX compatible
(function() {
    let draggedElement = null;
    let placeholder = null;

    // Initialize drag and drop (called on page load and after htmx swaps)
    function initDragAndDrop() {
        const stepsList = document.getElementById('projectStepsList');
        if (!stepsList) return;

        // Create placeholder element
        function createPlaceholder() {
            const div = document.createElement('div');
            div.className = 'card bg-base-300 shadow-md border-2 border-dashed border-primary opacity-50';
            div.style.height = '80px';
            return div;
        }

        // Get element after which to insert
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('[draggable="true"]:not(.opacity-50)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;

                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Update step order (placeholder for htmx call)
        function updateStepOrder() {
            const steps = stepsList.querySelectorAll('[data-step-id]');
            const stepIds = Array.from(steps).map(step => step.dataset.stepId);
            
            console.log('New step order:', stepIds);

            // Example using htmx.ajax:
            htmx.ajax('POST', "{% url 'projects:reorder_steps' project_id=project.pk %}", {
                values: { step_order: stepIds },
                swap: 'none'
            });
            
            // OR using a hidden form with hx-trigger:
            // const orderInput = document.getElementById('step-order-input');
            // if (orderInput) {
            //     orderInput.value = JSON.stringify(stepIds);
            //     htmx.trigger(orderInput.closest('form'), 'submit');
            // }
        }

        // Handle drag start (using event delegation)
        stepsList.addEventListener('dragstart', (e) => {
            const target = e.target.closest('[draggable="true"]');
            if (!target) return;
            
            draggedElement = target;
            draggedElement.classList.add('opacity-50');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', draggedElement.innerHTML);
        });

        // Handle drag over
        stepsList.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';

            const afterElement = getDragAfterElement(stepsList, e.clientY);
            
            if (!placeholder) {
                placeholder = createPlaceholder();
            }

            if (afterElement == null) {
                stepsList.appendChild(placeholder);
            } else {
                stepsList.insertBefore(placeholder, afterElement);
            }
        });

        // Handle drag end
        stepsList.addEventListener('dragend', (e) => {
            if (draggedElement) {
                draggedElement.classList.remove('opacity-50');
                
                // Insert dragged element at placeholder position
                if (placeholder && placeholder.parentNode) {
                    placeholder.parentNode.insertBefore(draggedElement, placeholder);
                    placeholder.remove();
                }
                
                // Send new order to server
                updateStepOrder();
                
                draggedElement = null;
                placeholder = null;
            }
        });

        // Handle drag leave
        stepsList.addEventListener('dragleave', (e) => {
            if (e.target === stepsList && placeholder) {
                placeholder.remove();
                placeholder = null;
            }
        });
    }

    // Initialize on page load
    initDragAndDrop();

    // Re-initialize after htmx swaps content into #projectStepsList
    document.body.addEventListener('htmx:afterSwap', (event) => {
        // Only reinitialize if the swap affected our steps list
        if (event.detail.target.id === 'projectStepsList' || 
            event.detail.target.closest('#projectStepsList')) {
            console.log('HTMX swapped content, drag-and-drop still active via event delegation');
            // Event listeners are still active due to delegation, no need to reinit
        }
    });
})();
</script>